<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analytics Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #333; }
        nav { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #007bff; }
        nav a { margin-right: 15px; text-decoration: none; color: #007bff; padding: 5px 10px; }
        nav a:hover { background-color: #e6f2ff; border-radius: 4px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
        .dashboard-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }
        .dashboard-card h3 { margin-top: 0; color: #007bff; }
        button { background-color: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        .content-list { max-height: 400px; overflow-y: auto; }
        .content-item { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .content-item:hover { background-color: #e6f2ff; }
        .content-title { font-weight: bold; color: #333; }
        .content-stats { color: #666; font-size: 0.9em; }
        .rating-gold { color: #d6b300; font-weight: bold; }
        .views-green { color: #28a745; font-weight: bold; }
        .empty-state { text-align: center; padding: 20px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Analytics Dashboard</h1>
        <nav>
            <a href="/">Dashboard</a>
            <a href="/renew">Renew Subscription</a>
            <a href="/content">Browse Content</a>
            <a href="/watchlist">My Watchlist</a>
            <a href="/recommendations">Recommendations</a>
            <a href="/search">Search</a>
            <a href="/users">Users</a>
            <a href="/analytics">Analytics</a>
        </nav>

        <div class="dashboard-grid">
            <!-- Top Rated Content Card -->
            <div class="dashboard-card">
                <h3>üèÜ Top Rated Content</h3>
                <div>
                    <label>Show top: </label>
                    <button onclick="loadTopRated(5)">5</button>
                    <button onclick="loadTopRated(10)">10</button>
                    <button onclick="loadTopRated(20)">20</button>
                </div>
                <div id="topRatedContainer" class="content-list">
                    <div class="empty-state">Click a button to load data</div>
                </div>
            </div>

            <!-- Most Popular Content Card -->
            <div class="dashboard-card">
                <h3>üî• Most Popular (Views)</h3>
                <div>
                    <label>Show top: </label>
                    <button onclick="loadPopular(5)">5</button>
                    <button onclick="loadPopular(10)">10</button>
                    <button onclick="loadPopular(20)">20</button>
                </div>
                <div id="popularContainer" class="content-list">
                    <div class="empty-state">Click a button to load data</div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid" style="margin-top: 20px;">
            <!-- Genre Distribution Card -->
            <div class="dashboard-card">
                <h3>üìä Browse by Genre</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                    <button onclick="loadGenreContent('Drama')">Drama</button>
                    <button onclick="loadGenreContent('Comedy')">Comedy</button>
                    <button onclick="loadGenreContent('Action')">Action</button>
                    <button onclick="loadGenreContent('Romance')">Romance</button>
                    <button onclick="loadGenreContent('Thriller')">Thriller</button>
                    <button onclick="loadGenreContent('Horror')">Horror</button>
                </div>
                <h4 id="genreTitle" style="margin-top: 15px;"></h4>
                <div id="genreContainer" class="content-list">
                    <div class="empty-state">Select a genre to view content</div>
                </div>
            </div>

            <!-- User Statistics Card -->
            <div class="dashboard-card">
                <h3>üë• User Overview</h3>
                <button onclick="loadUserStats()">Load User Statistics</button>
                <div id="userStatsContainer" style="margin-top: 15px;">
                    <div class="empty-state">Click to load user statistics</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load Top Rated Content
        function loadTopRated(limit) {
            const container = document.getElementById('topRatedContainer');
            container.innerHTML = '<div class="empty-state">Loading...</div>';

            fetch(`/api/content/top-rated?limit=${limit}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        container.innerHTML = `<div class="empty-state" style="color: #dc3545;">${data.message}</div>`;
                        return;
                    }

                    if (data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No data available</div>';
                        return;
                    }

                    let html = '';
                    data.forEach((item, index) => {
                        html += `
                        <div class="content-item">
                            <div>
                                <div class="content-title">${index + 1}. ${item.Title}</div>
                                <div class="content-stats">
                                    ${item.Type} | ${item.Release_Year} | ${item.Genre || 'N/A'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="rating-gold">‚≠ê ${item.Content_Rating || 'N/A'}</div>
                                <div class="views-green">${item.Total_Views} views</div>
                            </div>
                        </div>
                        `;
                    });
                    container.innerHTML = html;
                })
                .catch(error => {
                    container.innerHTML = `<div class="empty-state" style="color: #dc3545;">Error: ${error.message}</div>`;
                });
        }

        // Load Popular Content
        function loadPopular(limit) {
            const container = document.getElementById('popularContainer');
            container.innerHTML = '<div class="empty-state">Loading...</div>';

            fetch(`/api/content/popular?limit=${limit}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        container.innerHTML = `<div class="empty-state" style="color: #dc3545;">${data.message}</div>`;
                        return;
                    }

                    if (data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No data available</div>';
                        return;
                    }

                    let html = '';
                    data.forEach((item, index) => {
                        html += `
                        <div class="content-item">
                            <div>
                                <div class="content-title">${index + 1}. ${item.Title}</div>
                                <div class="content-stats">
                                    ${item.Type} | ${item.Release_Year} | ${item.Genre || 'N/A'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="views-green">üëÅ ${item.Total_Views} views</div>
                                <div class="rating-gold">‚≠ê ${item.Content_Rating || 'N/A'}</div>
                            </div>
                        </div>
                        `;
                    });
                    container.innerHTML = html;
                })
                .catch(error => {
                    container.innerHTML = `<div class="empty-state" style="color: #dc3545;">Error: ${error.message}</div>`;
                });
        }

        // Load Content by Genre
        function loadGenreContent(genre) {
            const container = document.getElementById('genreContainer');
            const title = document.getElementById('genreTitle');
            
            container.innerHTML = '<div class="empty-state">Loading...</div>';
            title.textContent = `${genre} Content`;

            fetch(`/api/content/by-genre/${genre}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        container.innerHTML = `<div class="empty-state" style="color: #dc3545;">${data.message}</div>`;
                        return;
                    }

                    if (data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No content in this genre</div>';
                        return;
                    }

                    let html = '';
                    data.forEach((item, index) => {
                        if (index < 10) { // Limit to 10 items for display
                            html += `
                            <div class="content-item">
                                <div>
                                    <div class="content-title">${item.Title}</div>
                                    <div class="content-stats">
                                        ${item.Type} | ${item.Release_Year} | ${item.Language}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div class="rating-gold">‚≠ê ${item.Content_Rating || 'N/A'}</div>
                                    <div class="views-green">${item.Total_Views} views</div>
                                </div>
                            </div>
                            `;
                        }
                    });
                    
                    if (data.length > 10) {
                        html += `<div class="empty-state">...and ${data.length - 10} more</div>`;
                    }
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    container.innerHTML = `<div class="empty-state" style="color: #dc3545;">Error: ${error.message}</div>`;
                });
        }

        // Load User Statistics
        function loadUserStats() {
            const container = document.getElementById('userStatsContainer');
            container.innerHTML = '<div class="empty-state">Loading...</div>';

            fetch('/api/users/all')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        container.innerHTML = `<div class="empty-state" style="color: #dc3545;">${data.message}</div>`;
                        return;
                    }

                    const totalUsers = data.length;
                    const activeUsers = data.filter(u => u.Status === 'Active').length;
                    const expiredUsers = data.filter(u => u.Status === 'Expired').length;
                    
                    // Count by plan
                    const planCounts = {};
                    data.forEach(user => {
                        const plan = user.Plan_Name;
                        planCounts[plan] = (planCounts[plan] || 0) + 1;
                    });

                    let html = `
                        <div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">
                            <h4 style="margin-top: 0;">üìà User Statistics</h4>
                            <div style="margin: 10px 0;">
                                <strong>Total Users:</strong> ${totalUsers}
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>Active Subscriptions:</strong> 
                                <span style="color: #28a745; font-weight: bold;">${activeUsers}</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>Expired Subscriptions:</strong> 
                                <span style="color: #dc3545; font-weight: bold;">${expiredUsers}</span>
                            </div>
                            
                            <h4 style="margin-top: 20px;">üìä Subscription Plans</h4>
                    `;

                    for (const [plan, count] of Object.entries(planCounts)) {
                        const percentage = ((count / totalUsers) * 100).toFixed(1);
                        html += `
                            <div style="margin: 8px 0; padding: 8px; background: #f9f9f9; border-radius: 4px;">
                                <strong>${plan}:</strong> ${count} users (${percentage}%)
                                <div style="background: #ddd; height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden;">
                                    <div style="background: #007bff; height: 100%; width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }

                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    container.innerHTML = `<div class="empty-state" style="color: #dc3545;">Error: ${error.message}</div>`;
                });
        }

        // Auto-load some data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTopRated(10);
            loadPopular(10);
        });
    </script>
</body>
</html>